<!DOCTYPE html>
<html lang="fr-CA">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LUXIA — Suivi de temps</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <style>
    :root{
      --bg: #0b0c10;
      --panel: #12141a;
      --panel-2:#171924;
      --text: #eef1f7;
      --muted:#9aa3b2;
      --accent:#4f8cff;
      --accent-2:#6ee7b7;
      --danger:#ff5d5d;
      --warn:#ffb020;
      --ok:#22c55e;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
      --radius-sm: 12px;
      --gap: 12px;
      --gap-lg: 16px;
      --touch: 48px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0; background:linear-gradient(180deg,#0b0c10,#0b0c10 30%,#0d1018 60%,#0b0c10 100%);
      color:var(--text); font-family:var(--sans); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    .app{max-width:980px; margin:0 auto; padding: env(safe-area-inset-top) var(--gap) calc(24px + env(safe-area-inset-bottom));}
    header{
      position:sticky; top:0; z-index:10; background:rgba(11,12,16,.7); backdrop-filter:saturate(160%) blur(12px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .bar{display:flex; align-items:center; gap:10px; padding:10px var(--gap);}  
    .title{font-weight:800; letter-spacing:.4px}
    .chip{font-size:12px; color:var(--muted); padding:6px 10px; border:1px solid rgba(255,255,255,.08); border-radius:999px;}
    nav.tabs{display:flex; gap:8px; flex-wrap:wrap; padding:6px var(--gap) 12px;}
    nav.tabs button{flex:1 1 auto; min-width:120px; border:1px solid rgba(255,255,255,.08); background:var(--panel); color:var(--text);
      padding:10px 12px; border-radius:999px; font-weight:600}
    nav.tabs button.active{background:var(--accent); color:#09111d; border-color:transparent; box-shadow:0 4px 16px rgba(79,140,255,.35)}

    .grid{display:grid; gap:var(--gap)}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow)}
    .panel .hd{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.06)}
    .panel .bd{padding:12px;}
    .muted{color:var(--muted)}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .grow{flex:1}
    input[type=text], input[type=time], input[type=date], select{
      width:100%; padding:12px 14px; background:var(--panel-2); color:var(--text); border:1px solid rgba(255,255,255,.1); border-radius:12px; outline:none
    }
    input::placeholder{color:#778199}

    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; height:44px; padding:0 14px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:var(--panel-2); color:var(--text); font-weight:700}
    .btn.primary{background:var(--accent); color:#08121e; border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.warn{background:var(--warn); color:#1a1307; border-color:transparent}
    .btn.danger{background:var(--danger); color:#2b0808; border-color:transparent}
    .btn.ok{background:var(--ok); color:#02140a; border-color:transparent}

    .list{display:flex; flex-direction:column}
    .item{display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid rgba(255,255,255,.06)}
    .item:last-child{border-bottom:0}
    .color{width:12px; height:12px; border-radius:999px; box-shadow:0 0 0 3px rgba(255,255,255,.08)}
    .code{font-family:var(--mono); letter-spacing:.3px; font-weight:700}
    .badge{font-size:12px; padding:6px 8px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.06)}

    .tiny{font-size:12px}
    .hint{font-size:12px; color:var(--muted)}
    .sep{height:1px; background:rgba(255,255,255,.06); margin:10px 0}

    table{width:100%; border-collapse:separate; border-spacing:0; overflow:auto}
    th,td{padding:10px 8px; text-align:right; border-bottom:1px solid rgba(255,255,255,.06); white-space:nowrap}
    th:first-child, td:first-child{text-align:left}
    thead th{position:sticky; top:0; background:rgba(13,16,24,.9); backdrop-filter:blur(10px)}
    tbody tr:last-child td{border-bottom:0}
    .tot{font-weight:800}

    .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .toolbar .grow{min-width:130px}

    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1)}

    .footer{margin-top:16px; color:var(--muted); font-size:12px}

    .toast{position:fixed; bottom:calc(10px + env(safe-area-inset-bottom)); left:50%; transform:translateX(-50%); background:#0f172a; color:var(--text); padding:10px 14px; border:1px solid rgba(255,255,255,.1); border-radius:12px; box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:opacity .25s}
    .toast.show{opacity:1}

    .modal{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:20px; z-index:50}
    .modal.show{display:flex}
    .modal .card{width:min(720px,100%); background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:16px; box-shadow:var(--shadow)}

    .kbd{font-family:var(--mono); font-size:12px; padding:2px 6px; border-radius:6px; border:1px solid rgba(255,255,255,.15)}

    /* (on mobile, on scrolle horizontalement plutôt que cacher les colonnes) */
    @media (max-width:640px){
      /* plus de hide-sm */
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">LUXIA — Suivi de temps</div>
      <div class="grow"></div>
      <div id="runningChip" class="chip">0 minuteur actif</div>
    </div>
    <nav class="tabs">
      <button data-tab="today" class="active">Aujourd'hui</button>
      <button data-tab="week">Semaine</button>
      <button data-tab="projects">Projets</button>
      <button data-tab="history">Historique</button>
      <button data-tab="settings">Réglages</button>
    </nav>
  </header>

  <main class="app grid" id="view">

    <!-- TODAY -->
    <section id="tab-today" class="grid">
      <div class="panel">
        <div class="hd">
          <div>
            <strong>Minuteurs</strong>
            <div class="tiny muted">Démarre/arrête des projets. Plusieurs minuteurs en parallèle si autorisé.</div>
          </div>
          <div class="toolbar">
            <button class="btn" id="stopAllBtn">■ Arrêter tout</button>
          </div>
        </div>
        <div class="bd grid" style="gap:14px">
          <div class="row">
            <input id="projectInput" class="grow" type="text" inputmode="latin" autocomplete="off" autocapitalize="characters" placeholder="Entrer un code projet (ex: X1772BC)" />
            <button id="quickStartBtn" class="btn primary">▶ Démarrer</button>
          </div>
          <div id="quickList" class="list"></div>
        </div>
      </div>

      <div class="panel">
        <div class="hd">
          <div><strong>Résumé du jour</strong> <span class="hint" id="todayLabel"></span></div>
          <div class="toolbar">
            <button class="btn" id="copyDayBtn">Copier</button>
          </div>
        </div>
        <div class="bd">
          <div id="todaySummary"></div>
        </div>
      </div>
    </section>

    <!-- WEEK -->
    <section id="tab-week" class="grid" style="display:none">
      <div class="panel">
        <div class="hd">
          <div class="toolbar">
            <button class="btn" id="prevWeek">←</button>
            <div class="pill"><span class="muted">Semaine :</span> <strong id="weekRange"></strong></div>
            <button class="btn" id="nextWeek">→</button>
            <button class="btn" id="thisWeek">Cette semaine</button>
          </div>
          <div class="toolbar">
            <button class="btn" id="copyWeek">Copier résumé</button>
            <button class="btn" id="exportWeekCSV">Exporter CSV</button>
          </div>
        </div>
        <div class="bd">
          <div id="weekTableWrap"></div>
          <div class="sep"></div>
          <div id="weekDayTotals"></div>
        </div>
      </div>
    </section>

    <!-- PROJECTS -->
    <section id="tab-projects" class="grid" style="display:none">
      <div class="panel">
        <div class="hd">
          <div><strong>Projets</strong></div>
          <div class="toolbar">
            <button class="btn" id="newProjectBtn">+ Nouveau</button>
          </div>
        </div>
        <div class="bd">
          <div id="projectList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="tab-history" class="grid" style="display:none">
      <div class="panel">
        <div class="hd">
          <div><strong>Historique & Édition</strong> <span class="hint">Ajouter/modifier/supprimer des sessions</span></div>
          <div class="toolbar">
            <input type="date" id="histDate">
            <select id="histProject"></select>
            <button class="btn" id="addSessionBtn">+ Ajouter une session</button>
          </div>
        </div>
        <div class="bd">
          <div id="historyList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="grid" style="display:none">
      <div class="panel">
        <div class="hd"><strong>Réglages</strong></div>
        <div class="bd grid">
          <div class="row">
            <label class="grow">Autoriser plusieurs minuteurs en même temps
              <div class="hint">Désactive pour ne permettre qu'un seul projet actif à la fois</div>
            </label>
            <select id="allowMulti">
              <option value="true">Oui</option>
              <option value="false">Non</option>
            </select>
          </div>
          <div class="row">
            <label class="grow">Début de semaine
              <div class="hint">Lundi recommandé au Québec</div>
            </label>
            <select id="weekStart">
              <option value="1">Lundi</option>
              <option value="0">Dimanche</option>
            </select>
          </div>
          <div class="row">
            <label class="grow">Alerte longue session (heures)
              <div class="hint">0 = jamais</div>
            </label>
            <select id="longAlert">
              <option>0</option>
              <option>2</option>
              <option>3</option>
              <option>4</option>
              <option>6</option>
              <option>8</option>
            </select>
          </div>
          <div class="sep"></div>
          <div class="toolbar">
            <button class="btn" id="backupBtn">Exporter JSON (sauvegarde)</button>
            <input type="file" id="restoreFile" accept="application/json" style="display:none">
            <button class="btn" id="restoreBtn">Importer JSON</button>
            <button class="btn warn" id="resetSettingsBtn">Réinitialiser réglages</button>
            <button class="btn danger" id="wipeBtn">Effacer toutes les données</button>
          </div>
          <div class="footer">Toutes les données restent <strong>localement</strong> sur cet appareil (localStorage). Aucune donnée envoyée ailleurs.</div>
        </div>
      </div>
    </section>
  </main>

  <!-- MODALS -->
  <div class="modal" id="modalEdit">
    <div class="card">
      <div class="hd">
        <strong id="modalTitle">Session</strong>
        <div class="toolbar">
          <button class="btn" id="closeModal">Fermer</button>
        </div>
      </div>
      <div class="bd grid">
        <div class="row">
          <label class="grow">Projet</label>
          <select id="mProject" class="grow"></select>
        </div>
        <div class="row">
          <div class="grow">
            <label>Début</label>
            <input type="datetime-local" id="mStart">
          </div>
          <div class="grow">
            <label>Fin</label>
            <input type="datetime-local" id="mEnd">
          </div>
        </div>
        <div class="row">
          <button class="btn ok" id="saveSession">Enregistrer</button>
          <button class="btn danger" id="deleteSession">Supprimer</button>
        </div>
        <div class="hint">Astuce: laisse "Fin" vide pour une session en cours.</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  // ===== UTIL =====
  const $ = (sel, p=document) => p.querySelector(sel);
  const $$ = (sel, p=document) => Array.from(p.querySelectorAll(sel));
  const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));

  const fmtHM = (sec)=>{
    sec = Math.max(0, Math.floor(sec));
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    return `${h}h${String(m).padStart(2,'0')}`;
  };
  const fmtHMS = (sec)=>{
    sec = Math.max(0, Math.floor(sec));
    const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
    return `${h}h${String(m).padStart(2,'0')}m${String(s).padStart(2,'0')}s`;
  };
  const toISO = (ms)=> new Date(ms).toISOString();
  const fromLocalDateTime = (val)=>{ // 'YYYY-MM-DDTHH:MM'
    if(!val) return null;
    const [d,t] = val.split('T');
    const [y,m,day] = d.split('-').map(Number);
    const [hh,mm] = (t||'00:00').split(':').map(Number);
    return new Date(y, m-1, day, hh, mm, 0, 0).getTime();
  };
  const toLocalDateTime = (ms)=>{
    const d = new Date(ms);
    const pad = (n)=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  };

  const startOfDay = (ms)=>{ const d=new Date(ms); return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime(); };
  const endOfDay = (ms)=> startOfDay(ms)+86400000; // exclusive

  const startOfWeek = (ms, weekStart=1)=>{
    const d = new Date(ms); const day = d.getDay();
    const diff = (day - weekStart + 7) % 7; // days since week start
    const sod = startOfDay(ms);
    return sod - diff*86400000;
  };

  const hashColor = (str)=>{
    let h = 0; for(let i=0;i<str.length;i++){ h = (h<<5) - h + str.charCodeAt(i); h|=0 }
    const r = (h>>16)&255, g=(h>>8)&255, b=h&255;
    const mix=(c)=> Math.round((c+255)/2); // lighten toward white
    return `rgb(${mix(Math.abs(r))}, ${mix(Math.abs(g))}, ${mix(Math.abs(b))})`;
  };

  const showToast=(msg)=>{ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000) };

  const copyText = async (text)=>{
    try{ await navigator.clipboard.writeText(text); showToast('Copié dans le presse-papiers'); }catch(e){
      const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showToast('Copié');
    }
  };

  // ===== DATA LAYER =====
  const KEY='luxia_time_v1';
  const now = ()=> Date.now();
  let data = JSON.parse(localStorage.getItem(KEY) || 'null');
  const DEFAULTS = { version:1, settings:{ allowMulti:true, weekStart:1, longAlertHours:4 }, projects:{} };
  if(!data){
    data = JSON.parse(JSON.stringify(DEFAULTS));
    persist();
  }
  function persist(){ localStorage.setItem(KEY, JSON.stringify(data)); }

  function ensureProject(code){
    const c = canonical(code);
    if(!data.projects[c]){
      data.projects[c] = { code:c, color: hashColor(c), sessions:[], archived:false, lastUsed: now() };
    }
    return data.projects[c];
  }
  function canonical(code){ return String(code||'').trim().toUpperCase(); }

  function activeSessions(){
    const list=[]; for(const p of Object.values(data.projects)){
      if(p.archived) continue;
      for(const s of p.sessions){ if(!s.end){ list.push({project:p, session:s}); } }
    }
    return list;
  }

  function stopAll(){
    const n = activeSessions().length;
    for(const {session} of activeSessions()){ session.end = now(); }
    if(n>0){ persist(); refresh(); showToast(`${n} minuteur${n>1?'s':''} arrêté${n>1?'s':''}`); }
  }

  // Split a session time into per-day seconds within [from, to)
  function splitSessionByDay(startMs, endMs, fromMs, toMs){
    const out = new Map();
    const s = Math.max(startMs, fromMs);
    const e = Math.min(endMs, toMs);
    if(e<=s) return out;
    let cur = startOfDay(s);
    while(cur<e){
      const dayEnd = endOfDay(cur);
      const segS = Math.max(s, cur);
      const segE = Math.min(e, dayEnd);
      const sec = Math.max(0, Math.floor((segE - segS)/1000));
      if(sec>0) out.set(cur, (out.get(cur)||0)+sec);
      cur = dayEnd;
    }
    return out;
  }

  function totalsByProject(fromMs, toMs){
    const perProject = new Map(); // code -> seconds
    for(const p of Object.values(data.projects)){
      if(p.archived) continue;
      for(const s of p.sessions){
        const end = s.end ?? now();
        const sParts = splitSessionByDay(s.start, end, fromMs, toMs);
        let sum=0; for(const v of sParts.values()) sum+=v;
        if(sum>0) perProject.set(p.code, (perProject.get(p.code)||0)+sum);
      }
    }
    return perProject;
  }

  function totalsByProjectPerDay(weekStartMs){
    const from = weekStartMs, to = weekStartMs + 7*86400000;
    const table = {}; // code -> [7]
    for(const p of Object.values(data.projects)){
      if(p.archived) continue;
      table[p.code] = new Array(7).fill(0);
      for(const s of p.sessions){
        const end = s.end ?? now();
        const parts = splitSessionByDay(s.start, end, from, to);
        for(const [dayStart, sec] of parts){
          const idx = Math.floor((dayStart - from)/86400000);
          if(idx>=0 && idx<7) table[p.code][idx]+=sec;
        }
      }
    }
    return table; // seconds
  }

  // ===== UI =====
  function setTab(name){
    $$('.tabs button').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
    ['today','week','projects','history','settings'].forEach(id=>{
      $('#tab-'+id).style.display = (id===name)?'grid':'none';
    });
    if(name==='week') buildWeek();
    if(name==='projects') buildProjects();
    if(name==='history') buildHistory();
    if(name==='settings') buildSettings();
    if(name==='today') buildToday();
  }

  // TODAY
  function buildToday(){
    $('#todayLabel').textContent = new Date().toLocaleDateString('fr-CA', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    const list=$('#quickList'); list.innerHTML='';

    const projects = Object.values(data.projects).filter(p=>!p.archived).sort((a,b)=> (b.lastUsed||0)-(a.lastUsed||0));
    if(projects.length===0){
      const empty = document.createElement('div');
      empty.className='hint';
      empty.textContent = 'Aucun projet. Ajoute un code ci-dessus et démarre le minuteur.';
      list.appendChild(empty);
    }
    for(const p of projects){
      const item=document.createElement('div'); item.className='item';
      const left=document.createElement('div'); left.className='row';
      const dot=document.createElement('div'); dot.className='color'; dot.style.background=p.color;
      const code=document.createElement('div'); code.className='code'; code.textContent=p.code;
      const todaySec = totalsByProject(startOfDay(now()), endOfDay(now())).get(p.code)||0;
      const today=document.createElement('div'); today.className='badge'; today.textContent = `Aujourd'hui ${fmtHM(todaySec)}`;
      left.append(dot, code, today);

      const right=document.createElement('div'); right.className='row';
      const running = p.sessions.some(s=>!s.end);
      const btn = document.createElement('button');
      btn.className='btn ' + (running? 'warn':'primary');
      btn.textContent = running ? '■ Stop' : '▶ Start';
      btn.onclick = ()=>{
        if(running){
          for(const s of p.sessions){ if(!s.end) s.end=now(); }
          data.lastStop = now();
        }else{
          if(!data.settings.allowMulti){ stopAll(); }
          p.sessions.push({ start: now(), end: null });
          p.lastUsed = now();
        }
        persist(); refresh();
      };
      const add15 = document.createElement('button'); add15.className='btn'; add15.textContent='+15m'; add15.onclick=()=>{ addManual(p.code, now()-15*60000, now()); };
      const add1h = document.createElement('button'); add1h.className='btn'; add1h.textContent='+1h'; add1h.onclick=()=>{ addManual(p.code, now()-60*60000, now()); };

      right.append(btn, add15, add1h);
      item.append(left,right);
      list.appendChild(item);
    }

    // Day summary table
    const perProject = totalsByProject(startOfDay(now()), endOfDay(now()));
    const entries = Array.from(perProject.entries()).sort((a,b)=>b[1]-a[1]);
    const wrap = $('#todaySummary');
    if(entries.length===0){ wrap.innerHTML = '<div class="hint">Aucune minute enregistrée aujourd\'hui.</div>'; return; }
    let html = '<div style="overflow:auto"><table><thead><tr><th>Projet</th><th>Durée</th></tr></thead><tbody>';
    let total=0; for(const [code,sec] of entries){ html+=`<tr><td><span class="code">${code}</span></td><td>${fmtHM(sec)}</td></tr>`; total+=sec; }
    html += `<tr class="tot"><td>Total</td><td>${fmtHM(total)}</td></tr></tbody></table></div>`;
    wrap.innerHTML = html;
  }

  // WEEK
  let currentWeekStart = startOfWeek(now(), data.settings.weekStart);

  function buildWeek(){
    $('#weekRange').textContent = weekRangeLabel(currentWeekStart);
    const table = totalsByProjectPerDay(currentWeekStart);
    const codes = Object.keys(table).sort();
    const dayNames = dayLabels();

    if(codes.length===0){ $('#weekTableWrap').innerHTML='<div class="hint">Aucun enregistrement sur cette période.</div>'; $('#weekDayTotals').innerHTML=''; return; }

    let html='<div style="overflow:auto"><table><thead><tr><th>Projet</th>';
    for(const d of dayNames) html+=`<th>${d.s}</th>`;
    html+='<th>Total</th></tr></thead><tbody>';

    const colTotals = new Array(7).fill(0);
    for(const code of codes){
      html+=`<tr><td><span class="code">${code}</span></td>`;
      let rowTot=0;
      for(let i=0;i<7;i++){ const sec=table[code][i]; colTotals[i]+=sec; rowTot+=sec; html+=`<td>${sec?fmtHM(sec):''}</td>`; }
      html+=`<td class="tot">${fmtHM(rowTot)}</td></tr>`;
    }
    html+='<tr class="tot"><td>Total</td>';
    for(let i=0;i<7;i++){ html+=`<td>${colTotals[i]?fmtHM(colTotals[i]):''}</td>`; }
    const grand = colTotals.reduce((a,b)=>a+b,0);
    html+=`<td class="tot">${fmtHM(grand)}</td></tr>`;

    html+='</tbody></table></div>';
    $('#weekTableWrap').innerHTML=html;

    // Totaux par jour (liste compacte juste en dessous)
    let dt='<table><thead><tr><th>Jour</th><th>Total jour</th></tr></thead><tbody>';
    for(let i=0;i<7;i++){
      dt+=`<tr><td>${dayNames[i].l}</td><td>${fmtHM(colTotals[i])}</td></tr>`;
    }
    dt+=`<tr class="tot"><td>Total semaine</td><td>${fmtHM(grand)}</td></tr></tbody></table>`;
    $('#weekDayTotals').innerHTML = dt;
  }

  function dayLabels(){
    const base = new Date(currentWeekStart);
    const fmtS=(d)=> d.toLocaleDateString('fr-CA',{weekday:'short', day:'2-digit', month:'2-digit'}).replace('.','');
    const fmtL=(d)=> d.toLocaleDateString('fr-CA',{weekday:'long', day:'2-digit', month:'2-digit'});
    const arr=[]; for(let i=0;i<7;i++){ const d=new Date(base.getTime()+i*86400000); arr.push({s:fmtS(d), l:fmtL(d)}); }
    return arr;
  }
  function weekRangeLabel(ws){
    const a = new Date(ws), b = new Date(ws+6*86400000);
    const fmt = (d)=> d.toLocaleDateString('fr-CA', {day:'2-digit', month:'2-digit'});
    const y = (d)=> d.getFullYear();
    return `${fmt(a)} – ${fmt(b)} ${y(b)}`;
  }

  // PROJECTS
  function buildProjects(){
    const list=$('#projectList'); list.innerHTML='';
    const projects = Object.values(data.projects).sort((a,b)=> (a.archived-b.archived) || (b.lastUsed||0)-(a.lastUsed||0) || a.code.localeCompare(b.code));
    if(projects.length===0){ list.innerHTML='<div class="hint">Aucun projet. Ajoute-en via l\'onglet Aujourd\'hui.</div>'; return; }
    for(const p of projects){
      const item=document.createElement('div'); item.className='item';
      const left=document.createElement('div'); left.className='row';
      const dot=document.createElement('div'); dot.className='color'; dot.style.background=p.color;
      const code=document.createElement('div'); code.className='code'; code.textContent=p.code + (p.archived? ' (archivé)':'' );
      const total = totalsByProject(0, now()).get(p.code)||0;
      const sum=document.createElement('div'); sum.className='badge'; sum.textContent=fmtHM(total);
      left.append(dot, code, sum);

      const right=document.createElement('div'); right.className='row';
      const rename=document.createElement('button'); rename.className='btn'; rename.textContent='Renommer'; rename.onclick=()=>{
        const nv=prompt('Nouveau code (lettres/chiffres, ex: X1772BC):', p.code) || '';
        const c = canonical(nv);
        if(!c) return;
        if(c!==p.code){
          if(data.projects[c]){ alert('Ce code existe déjà.'); return; }
          data.projects[c]= {...p, code:c}; delete data.projects[p.code];
        }
        persist(); refresh();
      };
      const archive=document.createElement('button'); archive.className='btn'; archive.textContent=p.archived? 'Restaurer':'Archiver'; archive.onclick=()=>{ p.archived=!p.archived; persist(); refresh(); };
      const del=document.createElement('button'); del.className='btn danger'; del.textContent='Supprimer'; del.onclick=()=>{
        if(confirm('Supprimer définitivement ce projet et toutes ses sessions ?')){ delete data.projects[p.code]; persist(); refresh(); }
      };
      right.append(rename, archive, del);
      item.append(left,right); list.appendChild(item);
    }
  }

  // HISTORY
  function buildHistory(){
    const dInput = $('#histDate');
    if(!dInput.value){
      const d = new Date();
      const pad=n=>String(n).padStart(2,'0');
      dInput.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    const pSel=$('#histProject'); pSel.innerHTML='<option value="">Tous les projets</option>';
    for(const p of Object.values(data.projects).filter(p=>!p.archived).sort((a,b)=>a.code.localeCompare(b.code))){
      const opt=document.createElement('option'); opt.value=p.code; opt.textContent=p.code; pSel.appendChild(opt);
    }
    renderHistoryList();
  }

  function renderHistoryList(){
    const list=$('#historyList'); list.innerHTML='';
    const dayMs = fromLocalDateTime($('#histDate').value+'T00:00');
    const from = dayMs, to = dayMs + 86400000;
    const filterCode = $('#histProject').value;
    const items=[];
    for(const p of Object.values(data.projects)){
      if(p.archived) continue;
      if(filterCode && p.code!==filterCode) continue;
      for(const s of p.sessions){
        const sEnd = s.end ?? now();
        if(sEnd<=from || s.start>=to) continue;
        items.push({p, s});
      }
    }
    items.sort((a,b)=> (a.s.start)-(b.s.start));
    if(items.length===0){ list.innerHTML='<div class="hint">Aucune session ce jour.</div>'; return; }
    for(const {p,s} of items){
      const item=document.createElement('div'); item.className='item';
      const left=document.createElement('div'); left.className='row';
      const dot=document.createElement('div'); dot.className='color'; dot.style.background=p.color;
      const code=document.createElement('div'); code.className='code'; code.textContent=p.code;
      const time=document.createElement('div'); time.className='badge';
      const endLabel = s.end? new Date(s.end).toLocaleTimeString('fr-CA',{hour:'2-digit',minute:'2-digit'}) : 'en cours…';
      time.textContent = `${new Date(s.start).toLocaleTimeString('fr-CA',{hour:'2-digit',minute:'2-digit'})} → ${endLabel}`;
      left.append(dot, code, time);

      const right=document.createElement('div'); right.className='row';
      const dur = document.createElement('div'); dur.className='badge'; dur.textContent = fmtHM(((s.end??now())-s.start)/1000);
      const edit=document.createElement('button'); edit.className='btn'; edit.textContent='Éditer'; edit.onclick=()=> openEditModal(p.code, s);
      right.append(dur, edit);

      item.append(left,right); list.appendChild(item);
    }
  }

  function openEditModal(code, session){
    $('#modalTitle').textContent = session? 'Modifier la session':'Nouvelle session';
    const sel=$('#mProject'); sel.innerHTML='';
    for(const p of Object.values(data.projects).filter(p=>!p.archived).sort((a,b)=>a.code.localeCompare(b.code))){
      const opt=document.createElement('option'); opt.value=p.code; opt.textContent=p.code; sel.appendChild(opt);
    }
    $('#mProject').value = code || '';
    $('#mStart').value = session? toLocalDateTime(session.start) : '';
    $('#mEnd').value = (session && session.end)? toLocalDateTime(session.end) : '';

    $('#saveSession').onclick = ()=>{
      const c = $('#mProject').value;
      const s = fromLocalDateTime($('#mStart').value);
      const e = fromLocalDateTime($('#mEnd').value);
      if(!c || !s){ alert('Projet et début obligatoires.'); return; }
      if(e && e<=s){ alert('Fin doit être après le début.'); return; }
      if(session){
        session.start = s; session.end = e||null; ensureProject(c).lastUsed = now();
        if(c!==code){ // move session to another project
          const old = data.projects[code];
          old.sessions = old.sessions.filter(x=>x!==session);
          ensureProject(c).sessions.push(session);
        }
      }else{
        ensureProject(c).sessions.push({start:s, end:e||null}); ensureProject(c).lastUsed = now();
      }
      closeModal(); persist(); refresh();
    };

    $('#deleteSession').onclick = ()=>{
      if(!session){ closeModal(); return; }
      if(confirm('Supprimer cette session ?')){
        const p = data.projects[code];
        p.sessions = p.sessions.filter(x=>x!==session);
        closeModal(); persist(); refresh();
      }
    };

    $('#modalEdit').classList.add('show');
  }
  function closeModal(){ $('#modalEdit').classList.remove('show'); }

  function addManual(code, start, end){
    ensureProject(code).sessions.push({start, end}); ensureProject(code).lastUsed = now(); persist(); refresh();
  }

  // SETTINGS
  function buildSettings(){
    $('#allowMulti').value = String(!!data.settings.allowMulti);
    $('#weekStart').value = String(data.settings.weekStart|0);
    $('#longAlert').value = String(data.settings.longAlertHours|0);
  }

  // EXPORT/IMPORT
  function exportWeekCSV(){
    const ws = currentWeekStart; const from = ws; const to = ws + 7*86400000;
    const per = totalsByProjectPerDay(ws);
    const days=[]; for(let i=0;i<7;i++) days.push(new Date(ws+i*86400000));
    let rows = [['Date','Jour','Projet','Durée (hh:mm)','Secondes']];
    for(const code of Object.keys(per).sort()){
      for(let i=0;i<7;i++){
        const sec = per[code][i]; if(!sec) continue;
        const d = days[i];
        const dateStr = d.toLocaleDateString('fr-CA');
        const dayStr = d.toLocaleDateString('fr-CA',{weekday:'long'});
        rows.push([dateStr, dayStr, code, fmtHM(sec), sec]);
      }
    }
    rows.push([]); rows.push(['Totaux projet']); rows.push(['Projet','Durée (hh:mm)','Secondes']);
    const totals = totalsByProject(from, to);
    for(const [code, sec] of Array.from(totals.entries()).sort((a,b)=>b[1]-a[1])){
      rows.push([code, fmtHM(sec), sec]);
    }

    const csv = rows.map(r=> r.map(v=> (v==null?'':String(v)).replaceAll('"','""')).map(v=>`"${v}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download = `luxia_semaine_${new Date(ws).toISOString().slice(0,10)}.csv`;
    a.click(); URL.revokeObjectURL(a.href);
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download = `luxia_backup_${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
    a.click(); URL.revokeObjectURL(a.href);
  }

  function importJSON(file){
    const reader=new FileReader(); reader.onload=()=>{
      try{
        const obj=JSON.parse(reader.result);
        if(!obj || typeof obj!=='object' || !obj.projects) throw new Error('Format invalide');
        data=obj; persist(); refresh(); showToast('Import réussi');
      }catch(e){ alert('Échec de l\'import: '+ e.message); }
    }; reader.readAsText(file);
  }

  // SUMMARY COPY
  function copyDaySummary(){
    const dayS = startOfDay(now()); const dayE = endOfDay(now());
    const totals = totalsByProject(dayS, dayE);
    let out = `Résumé du ${new Date(dayS).toLocaleDateString('fr-CA', {weekday:'long', year:'numeric', month:'long', day:'numeric'})}\n`;
    if(totals.size===0){ out+="Aucun temps enregistré."; copyText(out); return; }
    let sum=0; for(const [code,sec] of totals){ out += `- ${code}: ${fmtHM(sec)}\n`; sum+=sec; }
    out += `Total jour: ${fmtHM(sum)}`;
    copyText(out);
  }

  function copyWeekSummary(){
    const ws = currentWeekStart; const from = ws; const to = ws + 7*86400000;
    const perDay = totalsByProjectPerDay(ws);
    const days=[]; for(let i=0;i<7;i++) days.push(new Date(ws+i*86400000));
    let out = `Semaine du ${new Date(from).toLocaleDateString('fr-CA')} au ${new Date(to-86400000).toLocaleDateString('fr-CA')}\n`;
    for(let i=0;i<7;i++){
      const d=days[i]; const label=d.toLocaleDateString('fr-CA',{weekday:'long', day:'2-digit', month:'2-digit'});
      let lines=[];
      for(const code of Object.keys(perDay).sort()){
        const sec = perDay[code][i]; if(sec) lines.push(`  - ${code}: ${fmtHM(sec)}`);
      }
      if(lines.length>0){ out += `${label}\n${lines.join('\n')}\n`; }
    }
    const totals = totalsByProject(from, to);
    out+=`Totaux par projet:\n`;
    for(const [code,sec] of Array.from(totals.entries()).sort((a,b)=>b[1]-a[1])) out+=`- ${code}: ${fmtHM(sec)}\n`;
    const grand = Array.from(totals.values()).reduce((a,b)=>a+b,0);
    out+=`Total semaine: ${fmtHM(grand)}`;
    copyText(out);
  }

  // LONG SESSION ALERT
  let longAlertTimer=null;
  function scheduleLongAlertCheck(){
    if(longAlertTimer) clearInterval(longAlertTimer);
    const hours = data.settings.longAlertHours|0; if(!hours) return;
    const maxMs = hours*3600000;
    longAlertTimer = setInterval(()=>{
      for(const {project, session} of activeSessions()){
        if(now() - session.start > maxMs){
          showToast(`Le minuteur ${project.code} tourne depuis plus de ${hours}h`);
        }
      }
    }, 60*1000);
  }

  // ===== EVENTS =====
  $$('.tabs button').forEach(b=> b.onclick=()=> setTab(b.dataset.tab));

  $('#quickStartBtn').onclick = ()=>{
    const code = canonical($('#projectInput').value);
    if(!code || !/^[A-Z0-9\-]{2,20}$/.test(code)){ showToast('Code projet invalide'); return; }
    const p = ensureProject(code);
    if(!data.settings.allowMulti){ stopAll(); }
    p.sessions.push({start:now(), end:null}); p.lastUsed=now();
    $('#projectInput').value=''; persist(); refresh(); setTab('today');
  };
  $('#projectInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ $('#quickStartBtn').click(); }});

  $('#stopAllBtn').onclick = stopAll;
  $('#copyDayBtn').onclick = copyDaySummary;

  // Week controls
  $('#prevWeek').onclick = ()=>{ currentWeekStart -= 7*86400000; buildWeek(); };
  $('#nextWeek').onclick = ()=>{ currentWeekStart += 7*86400000; buildWeek(); };
  $('#thisWeek').onclick = ()=>{ currentWeekStart = startOfWeek(now(), data.settings.weekStart); buildWeek(); };
  $('#copyWeek').onclick = copyWeekSummary;
  $('#exportWeekCSV').onclick = exportWeekCSV;

  // Projects
  $('#newProjectBtn').onclick = ()=>{
    const nv = canonical(prompt('Code projet (ex: X1772BC):',''));
    if(!nv) return; if(data.projects[nv]){ alert('Existe déjà'); return; }
    ensureProject(nv); persist(); refresh();
  };

  // History
  $('#histDate').addEventListener('change', renderHistoryList);
  $('#histProject').addEventListener('change', renderHistoryList);
  $('#addSessionBtn').onclick = ()=> openEditModal('', null);

  // Modal
  $('#closeModal').onclick = closeModal;

  // Settings
  $('#allowMulti').onchange = (e)=>{ data.settings.allowMulti = (e.target.value==='true'); persist(); refresh(); };
  $('#weekStart').onchange = (e)=>{ data.settings.weekStart = parseInt(e.target.value||'1',10); persist(); currentWeekStart=startOfWeek(now(), data.settings.weekStart); refresh(); };
  $('#longAlert').onchange = (e)=>{ data.settings.longAlertHours = parseInt(e.target.value||'0',10); persist(); scheduleLongAlertCheck(); };

  // Backup/restore
  $('#backupBtn').onclick = exportJSON;
  $('#restoreBtn').onclick = ()=> $('#restoreFile').click();
  $('#restoreFile').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f) importJSON(f); e.target.value=''; });

  // Hard wipe (fiable sur iOS/desktop) + reset settings only
  $('#resetSettingsBtn').onclick = ()=>{
    if(confirm('Réinitialiser les réglages par défaut ?')){
      data.settings = JSON.parse(JSON.stringify(DEFAULTS.settings));
      persist(); refresh(); showToast('Réglages réinitialisés');
    }
  };
  $('#wipeBtn').onclick = ()=>{
    if(confirm('Tout effacer (projets + sessions + réglages) ?')){
      try{
        localStorage.removeItem(KEY);
        data = JSON.parse(JSON.stringify(DEFAULTS));
        persist(); refresh();
        showToast('Toutes les données ont été effacées');
      }catch(e){
        alert('Erreur lors de l\'effacement: ' + e.message);
      }
    }
  };

  // Live ticker
  let tickT=null;
  function startTicker(){ if(tickT) clearInterval(tickT); tickT=setInterval(()=>{
    updateRunningChip();
    if($('#tab-history').style.display!=='none') renderHistoryList();
    if($('#tab-today').style.display!=='none') buildToday();
  }, 1000); }

  function updateRunningChip(){
    const n = activeSessions().length;
    const chip = $('#runningChip');
    chip.textContent = `${n} minuteur${n>1?'s':''} actif${n>1?'s':''}`;
  }

  function refresh(){ updateRunningChip(); buildToday(); if($('#tab-week').style.display!=='none') buildWeek(); if($('#tab-projects').style.display!=='none') buildProjects(); if($('#tab-history').style.display!=='none') buildHistory(); scheduleLongAlertCheck(); }

  // INIT
  refresh(); startTicker();

  // iOS: prevent 300ms click delay issues
  document.addEventListener('touchstart', ()=>{}, {passive:true});
  </script>
</body>
</html>
